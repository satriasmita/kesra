(function(b){var i=function(){this.markers=[];this.mainMarker=!1;this.icon="http://www.google.com/mapfiles/marker.png"};i.prototype.dist=function(e){return Math.sqrt(Math.pow(this.markers[0].latitude-e.latitude,2)+Math.pow(this.markers[0].longitude-e.longitude,2))};i.prototype.setIcon=function(e){this.icon=e};i.prototype.addMarker=function(e){this.markers[this.markers.length]=e};i.prototype.getMarker=function(){if(this.mainmarker){return this.mainmarker}var f,e;1<this.markers.length?(f=new h.MarkerImage("http://thydzik.com/thydzikGoogleMap/markerlink.php?text="+this.markers.length+"&color=EF9D3F"),e="cluster of "+this.markers.length+" markers"):(f=new h.MarkerImage(this.icon),e=this.markers[0].title);return this.mainmarker=new h.Marker({position:new h.LatLng(this.markers[0].latitude,this.markers[0].longitude),icon:f,title:e,map:null})};var h=google.maps,g=new h.Geocoder,a=0,c=0,d={},d={init:function(f){var e,j=b.extend({},b.fn.gMap.defaults,f);for(e in b.fn.gMap.defaults.icon){j.icon[e]||(j.icon[e]=b.fn.gMap.defaults.icon[e])}return this.each(function(){var l=b(this),k=d._getMapCenter.apply(l,[j]);"fit"==j.zoom&&(j.zoomFit=!0,j.zoom=d._autoZoom.apply(l,[j]));var m={zoom:j.zoom,center:k,mapTypeControl:j.mapTypeControl,mapTypeControlOptions:{},zoomControl:j.zoomControl,zoomControlOptions:{},panControl:j.panControl,panControlOptions:{},scaleControl:j.scaleControl,scaleControlOptions:{},streetViewControl:j.streetViewControl,streetViewControlOptions:{},mapTypeId:j.maptype,scrollwheel:j.scrollwheel,maxZoom:j.maxZoom,minZoom:j.minZoom};j.controlsPositions.mapType&&(m.mapTypeControlOptions.position=j.controlsPositions.mapType);j.controlsPositions.zoom&&(m.zoomControlOptions.position=j.controlsPositions.zoom);j.controlsPositions.pan&&(m.panControlOptions.position=j.controlsPositions.pan);j.controlsPositions.scale&&(m.scaleControlOptions.position=j.controlsPositions.scale);j.controlsPositions.streetView&&(m.streetViewControlOptions.position=j.controlsPositions.streetView);j.styles&&(m.styles=j.styles);m.mapTypeControlOptions.style=j.controlsStyle.mapType;m.zoomControlOptions.style=j.controlsStyle.zoom;m=new h.Map(this,m);j.log&&console.log("map center is:");j.log&&console.log(k);l.data("$gmap",m);l.data("gmap",{opts:j,gmap:m,markers:[],markerKeys:{},infoWindow:null,clusters:[]});if(0!==j.controls.length){for(k=0;k<j.controls.length;k+=1){m.controls[j.controls[k].pos].push(j.controls[k].div)}}j.clustering.enabled?(k=l.data("gmap"),k.markers=j.markers,d._renderCluster.apply(l,[]),h.event.addListener(m,"bounds_changed",function(){d._renderCluster.apply(l,[])})):0!==j.markers.length&&d.addMarkers.apply(l,[j.markers]);d._onComplete.apply(l,[])})},_delayedMode:!1,_onComplete:function(){var f=this.data("gmap"),e=this;if(0!==a){window.setTimeout(function(){d._onComplete.apply(e,[])},100)}else{if(d._delayedMode){var j=d._getMapCenter.apply(this,[f.opts,!0]);d._setMapCenter.apply(this,[j]);f.opts.zoomFit&&(j=d._autoZoom.apply(this,[f.opts,!0]),f.gmap.setZoom(j))}f.opts.onComplete()}},_setMapCenter:function(f){var e=this.data("gmap");e&&e.opts.log&&console.log("delayed setMapCenter called");if(e&&void 0!==e.gmap&&0==a){e.gmap.setCenter(f)}else{var j=this;window.setTimeout(function(){d._setMapCenter.apply(j,[f])},100)}},_boundaries:null,_getBoundaries:function(j){var f=j.markers,o,k=1000,n=-1000,l=1000,m=-1000;if(f){for(o=0;o<f.length;o+=1){f[o].latitude&&f[o].longitude&&(k>f[o].latitude&&(k=f[o].latitude),n<f[o].longitude&&(n=f[o].longitude),l>f[o].longitude&&(l=f[o].longitude),m<f[o].latitude&&(m=f[o].latitude),j.log&&console.log(f[o].latitude,f[o].longitude,k,n,l,m))}d._boundaries={N:k,E:n,W:l,S:m}}-1000==k&&(d._boundaries={N:0,E:0,W:0,S:0});return d._boundaries},_getBoundariesFromMarkers:function(){var f=this.data("gmap").markers,e,m=1000,j=-1000,l=1000,k=-1000;if(f){for(e=0;e<f.length;e+=1){m>f[e].getPosition().lat()&&(m=f[e].getPosition().lat()),j<f[e].getPosition().lng()&&(j=f[e].getPosition().lng()),l>f[e].getPosition().lng()&&(l=f[e].getPosition().lng()),k<f[e].getPosition().lat()&&(k=f[e].getPosition().lat())}d._boundaries={N:m,E:j,W:l,S:k}}-1000==m&&(d._boundaries={N:0,E:0,W:0,S:0});return d._boundaries},_getMapCenter:function(f,e){var m,j=this,l,k;if(f.markers.length&&("fit"==f.latitude||"fit"==f.longitude)){return l=e?d._getBoundariesFromMarkers.apply(this):d._getBoundaries(f),m=new h.LatLng((l.N+l.S)/2,(l.E+l.W)/2),f.log&&console.log(e,l,m),m}if(f.latitude&&f.longitude){return m=new h.LatLng(f.latitude,f.longitude)}m=new h.LatLng(0,0);if(f.address){return g.geocode({address:f.address},function(n,o){o===google.maps.GeocoderStatus.OK?d._setMapCenter.apply(j,[n[0].geometry.location]):f.log&&console.log("Geocode was not successful for the following reason: "+o)}),m}if(0<f.markers.length){k=null;for(l=0;l<f.markers.length;l+=1){if(f.markers[l].setCenter){k=f.markers[l];break}}if(null===k){for(l=0;l<f.markers.length;l+=1){if(f.markers[l].latitude&&f.markers[l].longitude){k=f.markers[l];break}f.markers[l].address&&(k=f.markers[l])}}if(null===k){return m}if(k.latitude&&k.longitude){return new h.LatLng(k.latitude,k.longitude)}k.address&&g.geocode({address:k.address},function(n,o){o===google.maps.GeocoderStatus.OK?d._setMapCenter.apply(j,[n[0].geometry.location]):f.log&&console.log("Geocode was not successful for the following reason: "+o)})}return m},_renderCluster:function(){var u=this.data("gmap"),t=u.markers,s=u.clusters,o=u.opts,r;for(r=0;r<s.length;r+=1){s[r].getMarker().setMap(null)}s.length=0;if(r=u.gmap.getBounds()){var p=r.getNorthEast(),q=r.getSouthWest(),l=[],f=(p.lat()-q.lat())*o.clustering.clusterSize/100;for(r=0;r<t.length;r+=1){t[r].latitude<p.lat()&&(t[r].latitude>q.lat()&&t[r].longitude<p.lng()&&t[r].longitude>q.lng())&&(l[l.length]=t[r])}o.log&&console.log("number of markers "+l.length+"/"+t.length);o.log&&console.log("cluster radius: "+f);for(r=0;r<l.length;r+=1){p=-1;for(t=0;t<s.length&&!(q=s[t].dist(l[r]),q<f&&(p=t,o.clustering.fastClustering));t+=1){}-1===p?(t=new i,t.addMarker(l[r]),s[s.length]=t):s[p].addMarker(l[r])}o.log&&console.log("Total clusters in viewport: "+s.length);for(t=0;t<s.length;t+=1){s[t].getMarker().setMap(u.gmap)}}else{var n=this;window.setTimeout(function(){d._renderCluster.apply(n)},1000)}},_processMarker:function(u,t,s,o){var r=this.data("gmap"),p=r.gmap,q=r.opts,l;void 0===o&&(o=new h.LatLng(u.latitude,u.longitude));if(!t){var m={image:q.icon.image,iconSize:new h.Size(q.icon.iconsize[0],q.icon.iconsize[1]),iconAnchor:new h.Point(q.icon.iconanchor[0],q.icon.iconanchor[1]),infoWindowAnchor:new h.Size(q.icon.infowindowanchor[0],q.icon.infowindowanchor[1])};t=new h.MarkerImage(m.image,m.iconSize,null,m.iconAnchor)}s||(new h.Size(q.icon.shadowsize[0],q.icon.shadowsize[1]),m&&m.iconAnchor||new h.Point(q.icon.iconanchor[0],q.icon.iconanchor[1]));t={position:o,icon:t,title:u.title,map:null,draggable:!0===u.draggable?!0:!1};q.clustering.enabled||(t.map=p);l=new h.Marker(t);l.setShadow(s);r.markers.push(l);u.key&&(r.markerKeys[u.key]=l);var e;u.html&&(s={content:"string"===typeof u.html?q.html_prepend+u.html+q.html_append:u.html,pixelOffset:u.infoWindowAnchor},q.log&&console.log("setup popup with data"),q.log&&console.log(s),e=new h.InfoWindow(s),h.event.addListener(l,"click",function(){q.log&&console.log("opening popup "+u.html);q.singleInfoWindow&&r.infoWindow&&r.infoWindow.close();e.open(p,l);r.infoWindow=e}));u.html&&u.popup&&(q.log&&console.log("opening popup "+u.html),e.open(p,l),r.infoWindow=e);u.onDragEnd&&h.event.addListener(l,"dragend",function(f){q.log&&console.log("drag end");u.onDragEnd(f)})},_geocodeMarker:function(f,e,k){var j=this;g.geocode({address:f.address},function(m,l){l===h.GeocoderStatus.OK?(a-=1,j.data("gmap").opts.log&&console.log("Geocode was successful with point: ",m[0].geometry.location),d._processMarker.apply(j,[f,e,k,m[0].geometry.location])):(l===h.GeocoderStatus.OVER_QUERY_LIMIT&&(!j.data("gmap").opts.noAlerts&&0===c&&alert("Error: too many geocoded addresses! Switching to 1 marker/s mode."),c+=1000,window.setTimeout(function(){d._geocodeMarker.apply(j,[f,e,k])},c)),j.data("gmap").opts.log&&console.log("Geocode was not successful for the following reason: "+l))})},_autoZoom:function(j,f){var n=b(this).data("gmap"),l=b.extend({},n?n.opts:{},j),m,k,n=39135.758482;l.log&&console.log("autozooming map");m=f?d._getBoundariesFromMarkers.apply(this):d._getBoundaries(l);l=111000*(m.E-m.W)/this.width();k=111000*(m.S-m.N)/this.height();for(m=2;20>m&&!(l>n||k>n);m+=1){n/=2}return m-2},addMarkers:function(f){var e=this.data("gmap").opts;if(0!==f.length){e.log&&console.log("adding "+f.length+" markers");for(e=0;e<f.length;e+=1){d.addMarker.apply(this,[f[e]])}}},addMarker:function(s){var r=this.data("gmap").opts;r.log&&console.log("putting marker at "+s.latitude+", "+s.longitude+" with address "+s.address+" and html "+s.html);var q=r.icon.image,n=new h.Size(r.icon.iconsize[0],r.icon.iconsize[1]),p=new h.Point(r.icon.iconanchor[0],r.icon.iconanchor[1]),o=new h.Size(r.icon.infowindowanchor[0],r.icon.infowindowanchor[1]),l=r.icon.shadow,f=new h.Size(r.icon.shadowsize[0],r.icon.shadowsize[1]),e=new h.Point(r.icon.shadowanchor[0],r.icon.shadowanchor[1]);s.infoWindowAnchor=o;s.icon&&(s.icon.image&&(q=s.icon.image),s.icon.iconsize&&(n=new h.Size(s.icon.iconsize[0],s.icon.iconsize[1])),s.icon.iconanchor&&(p=new h.Point(s.icon.iconanchor[0],s.icon.iconanchor[1])),s.icon.infowindowanchor&&new h.Size(s.icon.infowindowanchor[0],s.icon.infowindowanchor[1]),s.icon.shadow&&(l=s.icon.shadow),s.icon.shadowsize&&(f=new h.Size(s.icon.shadowsize[0],s.icon.shadowsize[1])),s.icon.shadowanchor&&(e=new h.Point(s.icon.shadowanchor[0],s.icon.shadowanchor[1])));q=new h.MarkerImage(q,n,null,p);l=new h.MarkerImage(l,f,null,e);s.address?("_address"===s.html&&(s.html=s.address),"_address"==s.title&&(s.title=s.address),r.log&&console.log("geocoding marker: "+s.address),a+=1,d._delayedMode=!0,d._geocodeMarker.apply(this,[s,q,l])):("_latlng"===s.html&&(s.html=s.latitude+", "+s.longitude),"_latlng"==s.title&&(s.title=s.latitude+", "+s.longitude),r=new h.LatLng(s.latitude,s.longitude),d._processMarker.apply(this,[s,q,l,r]))},removeAllMarkers:function(){var f=this.data("gmap").markers,e;for(e=0;e<f.length;e+=1){f[e].setMap(null),delete f[e]}f.length=0},getMarker:function(e){return this.data("gmap").markerKeys[e]},fixAfterResize:function(f){var e=this.data("gmap");h.event.trigger(e.gmap,"resize");f&&e.gmap.panTo(new google.maps.LatLng(0,0));e.gmap.panTo(this.gMap("_getMapCenter",e.opts))},setZoom:function(j,f,l){var k=this.data("gmap").gmap;"fit"===j&&(j=d._autoZoom.apply(this,[f,l]));k.setZoom(parseInt(j))},changeSettings:function(j){var f=this.data("gmap"),l=[],k;for(k=0;k<f.markers.length;k+=1){l[k]={latitude:f.markers[k].getPosition().lat(),longitude:f.markers[k].getPosition().lng()}}j.markers=l;j.zoom&&d.setZoom.apply(this,[j.zoom,j]);(j.latitude||j.longitude)&&f.gmap.panTo(d._getMapCenter.apply(this,[j]))},mapclick:function(e){google.maps.event.addListener(this.data("gmap").gmap,"click",function(f){e(f.latLng)})},geocode:function(f,e,j){g.geocode({address:f},function(k,l){l===h.GeocoderStatus.OK?e(k[0].geometry.location):j&&j(k,l)})},getRoute:function(v){var u=this.data("gmap"),t=u.gmap,r=new h.DirectionsRenderer,s=new h.DirectionsService,q={BYCAR:h.DirectionsTravelMode.DRIVING,BYBICYCLE:h.DirectionsTravelMode.BICYCLING,BYFOOT:h.DirectionsTravelMode.WALKING},o={MILES:h.DirectionsUnitSystem.IMPERIAL,KM:h.DirectionsUnitSystem.METRIC},p=null,j=null,e=null;void 0!==v.routeDisplay?p=v.routeDisplay instanceof jQuery?v.routeDisplay[0]:"string"==typeof v.routeDisplay?b(v.routeDisplay)[0]:null:null!==u.opts.routeFinder.routeDisplay&&(p=u.opts.routeFinder.routeDisplay instanceof jQuery?u.opts.routeFinder.routeDisplay[0]:"string"==typeof u.opts.routeFinder.routeDisplay?b(u.opts.routeFinder.routeDisplay)[0]:null);r.setMap(t);null!==p&&r.setPanel(p);j=void 0!==q[u.opts.routeFinder.travelMode]?q[u.opts.routeFinder.travelMode]:q.BYCAR;e=void 0!==o[u.opts.routeFinder.travelUnit]?o[u.opts.routeFinder.travelUnit]:o.KM;s.route({origin:v.from,destination:v.to,travelMode:j,unitSystem:e},function(f,k){k==h.DirectionsStatus.OK?r.setDirections(f):null!==p&&b(p).html(u.opts.routeFinder.routeErrors[k])});return this}};b.fn.gMap=function(e){if(d[e]){return d[e].apply(this,Array.prototype.slice.call(arguments,1))}if("object"===typeof e||!e){return d.init.apply(this,arguments)}b.error("Method "+e+" does not exist on jQuery.gmap")};b.fn.gMap.defaults={log:!1,address:"",latitude:null,longitude:null,zoom:3,maxZoom:null,minZoom:null,markers:[],controls:{},scrollwheel:!0,maptype:google.maps.MapTypeId.ROADMAP,mapTypeControl:!0,zoomControl:!0,panControl:!1,scaleControl:!1,streetViewControl:!0,controlsPositions:{mapType:null,zoom:null,pan:null,scale:null,streetView:null},controlsStyle:{mapType:google.maps.MapTypeControlStyle.DEFAULT,zoom:google.maps.ZoomControlStyle.DEFAULT},singleInfoWindow:!0,html_prepend:'<div class="gmap_marker">',html_append:"</div>",icon:{image:"http://www.google.com/mapfiles/marker.png",iconsize:[20,34],iconanchor:[9,34],infowindowanchor:[9,2],shadow:"http://www.google.com/mapfiles/shadow50.png",shadowsize:[37,34],shadowanchor:[9,34]},onComplete:function(){},routeFinder:{travelMode:"BYCAR",travelUnit:"KM",routeDisplay:null,routeErrors:{INVALID_REQUEST:"The provided request is invalid.",NOT_FOUND:"One or more of the given addresses could not be found.",OVER_QUERY_LIMIT:"A temporary error occured. Please try again in a few minutes.",REQUEST_DENIED:"An error occured. Please contact us.",UNKNOWN_ERROR:"An unknown error occured. Please try again.",ZERO_RESULTS:"No route could be found within the given addresses."}},clustering:{enabled:!1,fastClustering:!1,clusterCount:10,clusterSize:40}}})(jQuery);